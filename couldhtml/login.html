<!-- <!DOCTYPE html>
<html>
  <head>
    <title>Login page</title>
    <style>
      .button-row {
        display: flex;
        justify-content: space-between;
      }

      button {
        flex: 1;
        margin: 0 5px;
      }
    </style>
  </head>
  <body>
    <h1>DJI Cloud API test</h1>

    <div class="button-row">
      <button id="login-button">Login</button>
      <button id="logout-button">Logout</button>
      <button id="raport-button">Raport</button>
    </div>
    <ul id="logs"></ul>
    <script>
      const APP_ID = 130943;
      const LICENSE =
        "HdMDWuYVpt05j3pIk+/vqoJlfY+SP6vp7z6XDyzGeM0d+Oy4JavUyYP/VsOw5i0UE07Lt5q9rzk9Jex1+CnPQO7OzBE6XwcNwZ0pDP/LPTjqdSPRezbmRB8z5yNf5QbEhe1YyLh++JzW9mr9BCkXy1v1h2+Uo0S1MSRZcLgLRw0=";
      const APP_KEY = "36de02838593125bbe9ab32d08813fb";
      var fieldList = document.getElementById("logs");
      var log = function (msg) {
        var li = document.createElement("li");
        li.innerText = msg;
        fieldList.appendChild(li);
      };
      var reg_calback = function () {
        log("Callback calledüéâ, arguments:" + Array.from(arguments));
      };
      var loginButton = document.getElementById("login-button");
      loginButton.addEventListener("click", function () {
        log("login");
        var token = window.djiBridge.platformVerifyLicense(
          APP_ID,
          APP_KEY,
          LICENSE
        );
        log("platform is verified: " + window.djiBridge.platformIsVerified());

        var register_params = JSON.stringify({
          host: "tcp://hostnamehere:1883", // mqtt address, example: tcp://xx.xx.xx.xx:xxx
          connectCallback: "reg_calback", // js interface for connection status callbacks
          username: "userloginhere",
          password: "userpasswordhere",
        });
        log(
          "Load Component: thing " +
            window.djiBridge.platformLoadComponent("thing", register_params) +
            "\n State‚ÑπÔ∏è: " +
            window.djiBridge.thingGetConnectState()
        );
        log(
          "Start the connection thingconn: " +
            window.djiBridge.thingConnect("userloginhere", "userpasswordhere", "reg_calback")
        );

        log("Thing Connect state: " + window.djiBridge.thingGetConnectState());
        // log("TODO here I am supposed to ask about login, password, gateway");
      });

      var logoutButton = document.getElementById("logout-button");
      logoutButton.addEventListener("click", function () {
        log(
          "unregistering: " + window.djiBridge.platformUnloadComponent("thing")
        );
      });

      document
        .getElementById("raport-button")
        .addEventListener("click", function () {
          log(
            "Statusy platformIsComponentLoaded: " +
              window.djiBridge.platformIsComponentLoaded("thing") +
              "\nthing state" +
              window.djiBridge.thingGetConnectState()
          );
        });

      log("platform is verified: " + window.djiBridge.platformIsVerified());
    </script>
  </body>
</html> -->

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>DJI Cloud API Login</title>
  <style>
    .button-row { display: flex; justify-content: space-between; margin-bottom: 1em; }
    button { flex: 1; margin: 0 5px; }
    #logs { list-style: none; padding: 0; font-family: monospace; }
  </style>
</head>
<body>
  <h1>DJI Cloud API Login</h1>
  <div class="button-row">
    <button id="login-button">Login</button>
    <button id="logout-button">Logout</button>
    <button id="report-button">Report</button>
  </div>
  <ul id="logs"></ul>

  <script>
    // „Çµ„Éº„Éê„ÉºÂÅ¥„ÅßÁΩÆÊèõ„Åï„Çå„Çã„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ
    const HOST = "hostnamehere";
    const USER = "userloginhere";
    const PASS = "userpasswordhere";

    // DJI Developer „Éù„Éº„Çø„É´„ÅßÂèñÂæó„Åó„ÅüÂÄ§
    const APP_ID = 168252;
    const APP_KEY = "90014c64b96a1822b28c27a57401e7c";
    const LICENSE = "pPtR5O/12yKso2H8oOOqwsDd9pV4f/MpJKjScqLDk5chRbRaX2LRwallcoWlFWKiCbIEVMw1HuE+KysY66BJMt+Bogw6Ys8aPE6rkSn47oMlYpsEBUm3g6nvMcopyQpo7Aqzqg4rEvUGvQnKTAhA9S55lK6HizhbF/t16x9YzcY=";

    const logs = document.getElementById("logs");
    function log(msg) {
      const li = document.createElement("li");
      li.textContent = new Date().toLocaleTimeString() + ": " + msg;
      logs.appendChild(li);
    }

    // ÂÖ¨Âºè„Éï„É≠„Éº„Å´Âæì„Å£„ÅüË™çË®ºÂÆüË£Ö
    document.getElementById("login-button").addEventListener("click", async () => {
      try {
        log("=== Login „Éó„É≠„Çª„ÇπÈñãÂßã ===");

        // Step 1: License Ê§úË®ºÔºàÂÖ¨Âºè„Éï„É≠„ÉºÂøÖÈ†àÔºâ
        log("Step 1: License Ê§úË®º‰∏≠...");
        const licenseResult = window.djiBridge.platformVerifyLicense(APP_ID, APP_KEY, LICENSE);
        log("License Ê§úË®ºÁµêÊûú: " + JSON.stringify(licenseResult));
        
        if (!window.djiBridge.platformIsVerified()) {
          throw new Error("License Ê§úË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
        }
        log("‚úì License Ê§úË®ºÊàêÂäü");

        // Step 2: Êó¢Â≠ò„Éà„Éº„ÇØ„É≥„ÅÆÁ¢∫Ë™ç
        log("Step 2: Êó¢Â≠ò„Éà„Éº„ÇØ„É≥Á¢∫Ë™ç‰∏≠...");
        let token = null;
        try {
          token = window.djiBridge.apiGetToken();
          log("Êó¢Â≠ò„Éà„Éº„ÇØ„É≥: " + (token ? "„ÅÇ„Çä" : "„Å™„Åó"));
        } catch (e) {
          log("Êó¢Â≠ò„Éà„Éº„ÇØ„É≥ÂèñÂæó„Ç®„É©„Éº: " + e.message);
        }

        // Step 3: „Éà„Éº„ÇØ„É≥„ÅåÁÑ°„ÅÑ„Åæ„Åü„ÅØÁÑ°Âäπ„Å™Â†¥Âêà„ÄÅÊñ∞Ë¶èÂèñÂæó
        if (!token) {
          log("Step 3: Êñ∞Ë¶è„Éà„Éº„ÇØ„É≥ÂèñÂæó‰∏≠...");
          const response = await fetch(`http://${HOST}:5000/auth/token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              username: USER, 
              password: PASS,
              app_id: APP_ID,
              app_key: APP_KEY 
            })
          });

          if (!response.ok) {
            throw new Error(`„Éà„Éº„ÇØ„É≥ÂèñÂæóÂ§±Êïó: ${response.status}`);
          }

          const tokenData = await response.json();
          token = tokenData.access_token;
          log("‚úì Êñ∞Ë¶è„Éà„Éº„ÇØ„É≥ÂèñÂæóÊàêÂäü: " + token.substring(0, 20) + "...");

          // API „É¢„Ç∏„É•„Éº„É´„Å´„Éà„Éº„ÇØ„É≥„ÇíË®≠ÂÆö
          window.djiBridge.apiSetToken(token);
        }

        // Step 4: Cloud Module „ÅÆ„É≠„Éº„Éâ
        log("Step 4: Cloud Module „É≠„Éº„Éâ‰∏≠...");
        const cloudParams = JSON.stringify({
          host: `tcp://${HOST}:1883`,
          connectCallback: "onMqttConnect",
          username: USER,
          password: token  // „Éà„Éº„ÇØ„É≥„Çí„Éë„Çπ„ÉØ„Éº„Éâ„Å®„Åó„Å¶‰ΩøÁî®
        });

        const loadResult = window.djiBridge.platformLoadComponent("thing", cloudParams);
        log("Cloud Module „É≠„Éº„ÉâÁµêÊûú: " + JSON.stringify(loadResult));

        // Step 5: MQTT Êé•Á∂öÈñãÂßã
        log("Step 5: MQTT Êé•Á∂öÈñãÂßã...");
        const connectResult = window.djiBridge.thingConnect(USER, token, "onMqttConnect");
        log("MQTT Êé•Á∂öÁµêÊûú: " + JSON.stringify(connectResult));

        // Step 6: „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„ÇπÊÉÖÂ†±Ë®≠ÂÆö
        log("Step 6: „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„ÇπÊÉÖÂ†±Ë®≠ÂÆö...");
        window.djiBridge.platformSetWorkspaceId("e3dea0f5-37f2-4d79-ae58-490af3228069");
        window.djiBridge.platformSetInformation("Test Platform", "Test Workspace", "„ÉÜ„Çπ„ÉàÁî®„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ");
        
        log("=== Login „Éó„É≠„Çª„ÇπÂÆå‰∫Ü ===");
        
      } catch (error) {
        log("‚ùå „Ç®„É©„Éº: " + error.message);
      }
    });

    document.getElementById("logout-button").addEventListener("click", () => {
      log("=== Logout „Éó„É≠„Çª„ÇπÈñãÂßã ===");
      try {
        window.djiBridge.thingDisconnect();
        window.djiBridge.platformUnloadComponent("thing");
        log("‚úì Logout ÂÆå‰∫Ü");
      } catch (e) {
        log("Logout „Ç®„É©„Éº: " + e.message);
      }
    });

    document.getElementById("report-button").addEventListener("click", () => {
      log("=== „Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç ===");
      try {
        log("LicenseË™çË®ºÊ∏à„Åø: " + window.djiBridge.platformIsVerified());
        log("Cloud Module „É≠„Éº„ÉâÊ∏à„Åø: " + window.djiBridge.platformIsComponentLoaded("thing"));
        log("MQTT Êé•Á∂öÁä∂ÊÖã: " + window.djiBridge.thingGetConnectState());
        const token = window.djiBridge.apiGetToken();
        log("ÁèæÂú®„ÅÆ„Éà„Éº„ÇØ„É≥: " + (token ? token.substring(0, 20) + "..." : "„Å™„Åó"));
      } catch (e) {
        log("„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Ç®„É©„Éº: " + e.message);
      }
    });

    // MQTT Êé•Á∂ö„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
    function onMqttConnect(code, message) {
      log(`MQTTÊé•Á∂ö„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ: code=${code}, message=${message}`);
    }
    window.onMqttConnect = onMqttConnect;

    log("„Éö„Éº„Ç∏ÂàùÊúüÂåñÂÆå‰∫Ü");
  </script>
</body>
</html>
